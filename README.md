# .NET Core Thread Count Monitoring

A bash script tool for monitoring thread counts in .NET Core applications and automatically collecting diagnostic information when thread counts exceed specified thresholds.

## Features

- Monitors thread pool thread count in real-time for .NET Core applications
- Configurable thread count threshold
- Automatic collection of memory dumps and/or profiler traces when threshold is exceeded
- Automatic upload of diagnostic files to Azure Blob Storage
- Log rotation and management
- Configurable cleanup process

## Prerequisites

- Linux environment
- .NET Core runtime
- The following tools installed in `/tools/` directory:
  - dotnet-counters
  - dotnet-trace
  - dotnet-dump
  - azcopy

## Usage

```bash
./netcore_threadcount_monitoring.sh -t <threshold> [enable-dump|enable-trace|enable-dump-trace]
```

### Options

- `-t <threshold>`: Set the thread count threshold (default: 100)
- `-h`: Display help information
- `-c`: Clean up all processes generated by the script

### Monitoring Modes

- `enable-dump`: Enable memory dump collection when threshold is exceeded
- `enable-trace`: Enable profiler trace collection when threshold is exceeded
- `enable-dump-trace`: Enable both memory dump and profiler trace collection

### Examples

```bash
# Monitor with default threshold (100 threads)
./netcore_threadcount_monitoring.sh

# Monitor with custom threshold of 150 threads
./netcore_threadcount_monitoring.sh -t 150

# Monitor and collect memory dumps when threshold is exceeded
./netcore_threadcount_monitoring.sh -t 150 enable-dump

# Monitor and collect both dumps and traces
./netcore_threadcount_monitoring.sh -t 150 enable-dump-trace

# Clean up all monitoring processes
./netcore_threadcount_monitoring.sh -c
```

## Output

The script creates the following output structure:

```
threadcount-logs-<instance>/
├── threadcount_YYYY-MM-DD_HH.log    # Hourly log files
├── dump_<instance>_YYYYMMDD_HHMMSS.dmp    # Memory dumps (if enabled)
└── trace_<instance>_YYYYMMDD_HHMMSS.nettrace    # Profiler traces (if enabled)
```

### Log Format

The log files contain entries in the following format:
```
TIMESTAMP: Thread Pool Thread Count: COUNT
```

## Azure Blob Storage Integration

The script automatically uploads diagnostic files (memory dumps and profiler traces) to Azure Blob Storage. It requires:

1. The `DIAGNOSTICS_AZUREBLOBCONTAINERSASURL` environment variable to be set with a valid Azure Blob Storage SAS URL
2. The `COMPUTERNAME` environment variable to be set for instance identification

## Error Handling

- Implements retry logic for Azure Blob Storage uploads (5 attempts)
- Graceful cleanup of processes on script termination
- Lock file mechanism to prevent duplicate dump/trace collection
- Automatic log rotation and size management

## Authors

- Original author: Tuan Hoang
- Updated by: Mainul Hossain

## Last Updated

12 Feb 2025